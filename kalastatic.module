<?php

/**
 * Implementation of hook_menu().
 */
function kalastatic_menu() {
  $items = array();

  $items['kalastatic'] = array(
    'title' => 'Kalastatic',
    'description' => 'Kalastatic config page.',
    'page callback' => 'kalastatic_config_page',
    'access arguments' => array('configure kalastatic'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['kalastatic/about'] = array(
    'title' => 'About',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0
  );

  $items['kalastatic/drupal-assets'] = array(
    'title' => 'Drupal Assets',
    'description' => 'A page containing the rendered output of the css and js.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kalastatic_assets_form'),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  $items['kalastatic/prototype'] = array(
    'title' => 'Prototype',
    'description' => 'The prototype that lives inside Kalastatic',
    'page callback' => 'kalastatic_prototype_redirect',
    'access arguments' => array('view kalastatic prototype'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );

  $items['kalastatic/styleguide'] = array(
    'title' => 'Styleguide',
    'description' => 'The styleguide that lives inside Kalastatic',
    'page callback' => 'kalastatic_styleguide_redirect',
    'access arguments' => array('view kalastatic styleguide'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  );
  
  $items['kalastatic/drupal-css'] = array(
    'title' => 'Drupal CSS',
    'description' => 'Return an array of information about the css being added to the page',
    'page callback' => 'kalastatic_asset_json',
    'page arguments' => array('css', 2),
    'access arguments' => array('access content'),
    'delivery callback' => 'kalastatic_asset_deliver',
  );

  $items['kalastatic/drupal-js'] = array(
    'title' => 'Drupal Javascript',
    'description' => 'Return an array of information about the js being added to the page',
    'page callback' => 'kalastatic_asset_json',
    'page arguments' => array('js', 2),
    'access arguments' => array('access content'),
    'delivery callback' => 'kalastatic_asset_deliver',
  );

  return $items;
}

/**
 * Implements hook_permission.
 */
function kalastatic_permission() {
  return array(
    'configure kalastatic' => array(
      'title' => t('Configure Kalastatic'),
      'description' => t('Access configuration pages provided by the Kalastatic Drupal integration module.'),
    ),
    'view kalastatic prototype' => array(
      'title' => t('View Kalastatic prototype'),
      'description' => t('View the prototype provided by Kalastatic.'),
    ),
    'view kalastatic styleguide' => array(
      'title' => t('View Kalastatic styleguide'),
      'description' => t('View the styleguide provided by Kalastatic.'),
    ),
  );
}

/**
 * Page callback for the Kalastatic config page.
 */
function kalastatic_config_page(){
  $features_list = array(
    'Metalsmith static site generator',
    'Swig template engine',
    'SASS CSS pre-processor',
    'KSS CSS Documentation and Styleguide',
    'Grunt for automating tasks',
  );
  
  return array(
    'description' =>  array(
      '#markup' => t('Static site framework for prototyping and building out CMS-less websites. See !link for more details.', array('!link' => l('https://github.com/kalamuna/kalastatic', 'https://github.com/kalamuna/kalastatic'))),
    ),
  );
}

/**
 * Return json formatted info about the css being added to the page.
 */
function kalastatic_asset_json($type){
  switch ($type){
    case 'css':
      $output = drupal_get_css();
      break;  
    
    case 'js':
      $output = drupal_get_js();
      break;
  }
    
  return $output;
}

/**
 * Delivery callback for returning Drupal css or js.
 */
function kalastatic_asset_deliver($assets){
  drupal_add_http_header('Content-Type', 'application/json; charset=utf-8');

  // Print the response.
  print $assets;

  // Perform end-of-request tasks.
  ajax_footer();
}


/**
 * Build a form containing the css and js in textareas so it can be copied and 
 * pasted.
 */
function kalastatic_assets_form($form, &$form_state){
  $css = kalastatic_asset_json('css');
  $js = kalastatic_asset_json('js');
  
  $form['description'] = array(
    '#markup' => 'Copy and paste the following markup into your html.html template to add the Drupal CSS and Javascript to Kalastatic.',
  );
  
  $form['css'] = array(
    '#title' => 'Drupal CSS',
    '#type' => 'textarea',
    '#default_value' => $css,
  );
  $form['js'] = array(        
    '#title' => 'Drupal Javascript',
    '#type' => 'textarea',
    '#default_value' => $js,
  );
  
  return $form;
}

/**
 * Page callback that just redirects to the prototype.
 */
function kalastatic_prototype_redirect(){
  // TODO: We need a better way to find out where KS is living.
  $path = 'sites/all/themes/kt_sub/kalastatic/build/index.html';
  drupal_goto($path);
}

/**
 * Page callback that just redirects to the styleguide.
 */
function kalastatic_styleguide_redirect(){
  // TODO: We need a better way to find out where KS is living.
  $path = 'sites/all/themes/kt_sub/kalastatic/build/styleguide';
  drupal_goto($path);
}